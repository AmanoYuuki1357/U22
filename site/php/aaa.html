<?php
    require('dbconnect.php');
    require('common.php');
    error_reporting(E_ALL & ~E_NOTICE);
    if(!isset($_SESSION)){
        session_start();
    }

    // セッションにユーザー情報があり、ログイン後に行動してから60分以内であるとき
    if(isset($_SESSION['id']) && $_SESSION['time'] + 3600>time()){
        // ログインした時間を現在の時間に更新
        $_SESSION['time']=time();
        // セッション変数のidを使って、ユーザーの情報を呼び出す
        $members=$db->prepare('SELECT * FROM user_info WHERE userID=?');
        $members->execute(array($_SESSION['id']));
        $member=$members->fetch();
        // ログインしていないとき
    }else{
        // 即時にログイン画面に転送する
        header('Location: login.php');
        exit();
    }

    
    // ヘッダーのアイコン
    $icons=$db->prepare('SELECT * FROM user_info WHERE userID=?');
    $icons->execute(array($_SESSION['id']));
    $icon=$icons->fetch();

    $id=$_GET['id'];
    if(!is_numeric($id) || $id<=0){
        print('1以上の数字で指定してください');
        exit();
    }

    // いいねを記録する
    if(!empty($_POST['good_t']) && !empty($_SESSION['ticket'])){
        if($_POST['good_t']==$_SESSION['ticket']){
            if($icon['goodsStock']>0){
                $statement=$db->prepare('UPDATE works_info set worksGooded=worksGooded+1 where worksID=?');
                $cnt=$statement->execute(array($id));
                $statement2=$db->prepare('UPDATE user_info set goodsStock=goodsStock-1 where userID=?');
                $cnt2=$statement2->execute(array($_SESSION['id']));
            }else{
                // header('Location: good_buy.php', false, 301);
                ?>
                <body onload="window.open('good_buy.php','newwin','width=1000,height=800')"></body>
                <?php
            }
        }
    }
    $ticket=mt_rand();
    $_SESSION['ticket']=$ticket;

    $works=$db->prepare('SELECT * FROM user_info u,works_info w WHERE u.userID=w.worksCreatedID and w.worksID=?');
    $works->execute(array($id));
    $work=$works->fetch();

?>

<!DOCTYPE html>
<html lang="ja">

    <head>

        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title><?php print(h($work['worksTitle'])); ?></title>
        <link rel="stylesheet" type="text/css" href="css/reset.css">
        <link rel="stylesheet" type="text/css" href="css/main.css">
        <link rel="stylesheet" type="text/css" href="css/works.css">

    </head>

    <body>
        <div id="wrap">
            <header>
                <!-- ハンバーガーメニュー -->
                <div class="hamburger">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                <nav class="globalMenuSp">
                    <ul>
                        <li><a href="home.php">ホーム</a></li>
                        <li><a href="ranking.php">ランキング</a></li>
                        <li><a href="recommendation.php">おすすめ</a></li>
                        <li><a href="new.php">新着</a></li>
                    </ul>
                </nav>

                <div id=icon>
                    <a href="home.php"><img src="images/pigsiv.jpg" alt="アイコン"></a>
                </div>

                <!-- 検索 -->
                <div id="search">
                    <form method="get" action="search.php">
                        <input type="text" name="search" size="15" placeholder="作品を検索">
                    </form>
                </div>

                <!-- 投稿ボタン -->
                <div id="contribute">
                    <a href="post.php">作品を投稿</a>
                </div>

                <!-- ユーザーメニュー -->
                <div id="user">
                    <label id="icon" onclick="display()">
                        <img src=icon_images/<?php print(h($icon["userIcon"])) ?> alt="アイコン">
                        <span></span>
                    </label>
                    <div id="menu" style="display: none;">
                        <ul>
                            <li><a href="profile.php">プロフィール</a></li>
                            <li><a href="my_works.php">投稿作品</a></li>
                            <li><a href="logout_do.php">ログアウト</a></li>
                        </ul>
                    </div>
                </div>
            </header>

            <main>
                <div class="bg clearfix">
                    <figure class="each">
                        <img src="post_images/<?php print(h($work['worksImage'])) ?>" alt="作品閲覧">
                    </figure>

                    <div class="info">
                        <div class="clearfix">
                            <p class="good">いいね&nbsp;&nbsp;<?php print(h($work['worksGooded'])) ?></p>
                            <form action="" method="post">
                                <input type="hidden" id="" name="good_t" value="<?php print($ticket) ?>"/>
                                <input class="good" type="submit" class="btn" value="いいね">
                            </form>
                        </div>

                        <!-- <p>ブックマーク</p> -->
                        <p>
                            作品タイトル<br>
                            <span><?php print(h($work['worksTitle'])) ?></span>
                        </p>
                        <p>
                            作者コメント<br>
                            <span><?php print(h($work['worksComment'])) ?></span>
                        </p>
                        <!-- <p>タグ</p> -->
                        <div>
                            <p>
                                作者<br>
                                <table id="creater">
                                    <tr>
                                        <td>
                                            <img src=icon_images/<?php print(h($work["userIcon"])) ?> alt="アイコン">
                                        </td>
                                        <td>
                                            <?php print(h($work['userName'])) ?>
                                        </td>
                                    </tr>
                                </table>
                            </p>
                        </div>
                    </div>
                </div>
            </main>

            <footer></footer>

        </div>

    <!-- jQuery -->
    <script src="js/jQuery.js"></script>
    <script src="js/main.js"></script>
    
    </body>

</html>